version: '3.9'

services:
  drupal:
    image: drupal:10-php8.3-fpm-alpine  # официальный образ Drupal 10 с PHP 8.3 + FPM
    container_name: drupal_app
    restart: unless-stopped
    volumes:
      - drupal_modules:/opt/drupal/modules
      - drupal_profiles:/opt/drupal/profiles
      - drupal_themes:/opt/drupal/themes
      - drupal_sites:/opt/drupal/sites
      - ./drupal-files:/opt/drupal/web/sites/default/files  # публичные файлы (картинки и т.д.)
    depends_on:
      - db
    environment:
      - DRUPAL_DB_HOST=db
      - DRUPAL_DB_NAME=drupal
      - DRUPAL_DB_USER=drupal
      - DRUPAL_DB_PASSWORD=drupalpass123

  nginx:
    image: nginx:alpine
    container_name: drupal_nginx
    restart: unless-stopped
    ports:
      - "8080:80"          # открываем на 8080 хоста, чтобы не конфликтовать с локальным 80
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - drupal_sites:/opt/drupal/sites:ro
      - ./drupal-files:/opt/drupal/web/sites/default/files:ro
    depends_on:
      - drupal

  db:
    image: postgres:16-alpine
    container_name: drupal_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: drupal
      POSTGRES_USER: drupal
      POSTGRES_PASSWORD: drupalpass123
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  drupal_modules:
  drupal_profiles:
  drupal_themes:
  drupal_sites:
  db_data:
